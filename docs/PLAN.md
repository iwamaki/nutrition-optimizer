# 栄養最適化メニュー生成システム - 開発計画

## コンセプト

1日に必要な栄養素を満たす最適な献立を自動生成するシステム。

### 解決する課題

- 栄養バランスを考慮した献立作成は、複数の栄養素を同時に満たす必要があり、人間が直感で解くのは困難
- 手計算による栄養管理は非現実的で継続しにくい

### アプローチ

- **数理最適化（線形計画法）** により、食材の組み合わせと量を自動調整
- **文部科学省 食品標準成分表（八訂）** を栄養素データの基盤とする
- **調理係数** により、加熱等による栄養素変化を反映（予定）

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    Flutter (Frontend)                    │
│                  Web / iOS / Android                     │
├─────────────────────────────────────────────────────────┤
│                         REST API                         │
├─────────────────────────────────────────────────────────┤
│                  FastAPI (Backend)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │   Routes    │  │   Solver    │  │   Data Loader   │  │
│  │  (API層)    │  │ (PuLP/CBC)  │  │ (Excel Parser)  │  │
│  └─────────────┘  └─────────────┘  └─────────────────┘  │
├─────────────────────────────────────────────────────────┤
│              SQLite + SQLAlchemy (永続化)                │
└─────────────────────────────────────────────────────────┘
```

---

## 最適化モデル

### 目的関数

栄養素目標との重み付き相対誤差を最小化:

```
minimize Σ (weight_i × |actual_i - target_i| / target_i)
```

### 決定変数

- `x[food_id]`: 各食材の使用量 (g)
- `y[food_id]`: 各食材の使用有無 (0/1)

### 制約条件

- カロリー範囲（目標 ± 許容範囲）
- 食材ごとの最大使用量
- 1食あたりの品数（2〜5品）
- カテゴリ除外（アレルギー等）

---

## 開発フェーズ

### Phase 0: MVP（完了）

- [x] FastAPI による REST API
- [x] PuLP + CBC Solver による最適化エンジン
- [x] SQLite + SQLAlchemy によるデータ永続化
- [x] 41品目のサンプル食材データ
- [x] Flutter による基本UI（メニュー表示、栄養グラフ）

### Phase 1: データ拡充（進行中）

- [x] 文科省食品成分表（Excel）パーサー実装
- [x] 2,000品目以上の食品データ投入
- [ ] 調理係数（加熱ロス、茹で汁廃棄等）のマスタ追加

### Phase 2: UI機能拡張

- [ ] 設定画面の実装
  - カロリー目標（1,500〜3,000 kcal）
  - 除外カテゴリ・食材
  - アレルギー対応
- [ ] 食材詳細画面（栄養素一覧）
- [ ] メニュー履歴・お気に入り機能

### Phase 3: 最適化の高度化

- [ ] 1週間ローテーション最適化（同じ食材の重複回避）
- [ ] 調理時間・調理難易度の制約追加
- [ ] コスト最適化（食材価格データ連携）
- [ ] 季節食材の優先度設定

### Phase 4: 実用化

- [ ] ユーザー認証（Firebase Auth等）
- [ ] クラウドデプロイ（Cloud Run + Cloud SQL）
- [ ] 買い物リスト生成機能
- [ ] レシピ提案（外部APIまたはLLM連携）

### Phase 5: フィードバックループ

- [ ] 実食記録機能
- [ ] 血液検査データ連携（オプション）
- [ ] 体調・満足度フィードバック
- [ ] 機械学習による嗜好学習

---

## データソース

### 食品成分表

- **出典**: 日本食品標準成分表（八訂）増補2023年
- **URL**: https://www.mext.go.jp/a_menu/syokuhinseibun/mext_00001.html
- **収録栄養素**: エネルギー、たんぱく質、脂質、炭水化物、食物繊維、ナトリウム、カルシウム、鉄、ビタミンA/C/D 等

### 調理係数（予定）

加熱調理による栄養素の変化を係数で補正:

| 調理法 | 対象栄養素 | 係数例 |
|--------|-----------|--------|
| 茹でる | ビタミンC | 0.5〜0.7 |
| 炒める | ビタミンB1 | 0.8〜0.9 |
| 揚げる | 脂質 | +吸油率 |

※ 食材×調理法の組み合わせが多いため、主要なものから段階的に実装

---

## API エンドポイント

| Method | Path | 説明 |
|--------|------|------|
| POST | `/api/v1/optimize` | メニュー最適化リクエスト |
| GET | `/api/v1/foods` | 食材一覧取得 |
| GET | `/api/v1/categories` | カテゴリ一覧取得 |
| PUT | `/api/v1/preferences` | ユーザー設定更新 |

---

## 技術スタック

### Backend
- Python 3.12
- FastAPI
- PuLP (CBC Solver)
- SQLAlchemy + SQLite
- pandas (Excel読み込み)

### Frontend
- Flutter 3.x
- Material Design 3
- fl_chart (グラフ描画)
- http (API通信)

---

## 起動方法

### Backend

```bash
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload
```

### Frontend (Web)

```bash
cd frontend
flutter pub get
flutter run -d chrome
```

---

*最終更新: 2026-01-10*
